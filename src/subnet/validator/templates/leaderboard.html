<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Miner Metrics Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        .network-container {
            margin-bottom: 50px;
        }
        .metric-table {
            margin: 0 auto;
            width: 80%;
            border-collapse: collapse;
        }
        .metric-table th, .metric-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .metric-table th {
            background-color: #f2f2f2;
            font-size: 24px;
        }
        .metric-table td {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <h1>Miner Metrics Dashboard</h1>
    <div id="metrics-container">
        <!-- Network tables will be appended here dynamically -->
    </div>

    <script>
        async function fetchMetrics() {
            try {
                const response = await fetch('/leaderboard'); // Adjust the URL if necessary
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const parsedData = await response.json();
                console.log('Received data:', parsedData);

                // Check if parsedData is an array
                if (Array.isArray(parsedData.data)) {
                    updateTables(parsedData.data);
                } else if (typeof parsedData.data === 'object' && parsedData.data !== null) {
                    // Handle object case, perhaps wrap it in an array
                    updateTables([parsedData.data]);
                } else {
                    console.error('Expected an array or object but received:', parsedData.data);
                }

            } catch (error) {
                console.error('Error fetching leaderboard data:', error);
            }
        }

        function updateTables(data) {
            // Get the metrics container element
            const metricsContainer = document.getElementById('metrics-container');

            // Clear existing network tables
            metricsContainer.innerHTML = '';

            // Iterate over the data array to construct separate tables for each network
            data.forEach(networkData => {
                // Check if 'networkData' has 'network' and 'data' properties
                if (!networkData.network || !Array.isArray(networkData.data)) {
                    console.error('Invalid data format:', networkData);
                    return;
                }

                // Create a container for the network
                const networkContainer = document.createElement('div');
                networkContainer.className = 'network-container';

                // Create a title for the network
                const networkTitle = document.createElement('h2');
                networkTitle.textContent = `Network: ${networkData.network}`;
                networkContainer.appendChild(networkTitle);

                // Create a table element
                const table = document.createElement('table');
                table.className = 'metric-table';

                // Create table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Network</th>
                        <th>Address</th>
                        <th>Updated</th>
                        <th>Rank</th>
                        <th>Total Receipts in last month</th>
                        <th>Accepted Receipts in last month</th>
                    </tr>
                `;
                table.appendChild(thead);

                // Create table body
                const tbody = document.createElement('tbody');
                networkData.data.forEach(minerData => {
                    // Create a new row
                    const row = document.createElement('tr');

                    // Create cells for the row
                    const networkCell = document.createElement('td');
                    networkCell.textContent = networkData.network;
                    row.appendChild(networkCell);

                    const minerKeyCell = document.createElement('td');
                    minerKeyCell.textContent = minerData.miner_key || 'N/A';
                    row.appendChild(minerKeyCell);

                    const timestampCell = document.createElement('td');
                    timestampCell.textContent = minerData.timestamp || 'N/A';
                    row.appendChild(timestampCell);

                    const rankCell = document.createElement('td');
                    rankCell.textContent = minerData.rank !== undefined ? minerData.rank : 'N/A';
                    row.appendChild(rankCell);

                    const totalReceiptsCell = document.createElement('td');
                    totalReceiptsCell.textContent = minerData.total_receipts !== undefined ? minerData.total_receipts : 'N/A';
                    row.appendChild(totalReceiptsCell);

                    const acceptedReceiptsCell = document.createElement('td');
                    acceptedReceiptsCell.textContent = minerData.accepted_receipts !== undefined ? minerData.accepted_receipts : 'N/A';
                    row.appendChild(acceptedReceiptsCell);

                    // Append the row to the table body
                    tbody.appendChild(row);
                });

                // Append the tbody to the table
                table.appendChild(tbody);

                // Add the table to the network container
                networkContainer.appendChild(table);

                // Add the network container to the metrics container
                metricsContainer.appendChild(networkContainer);
            });
        }

        // Fetch the metrics when the page loads
        fetchMetrics();

        // Optionally, you could refresh the data every 60 seconds
        setInterval(fetchMetrics, 60000);
    </script>
</body>
</html>
